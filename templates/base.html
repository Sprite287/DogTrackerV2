<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Rescue Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid justify-content-center">
    <a class="navbar-brand mx-3" href="/">Dog Rescue Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">Dog List</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/staff">Staff Management</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/rescue">Rescue Info</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/logout">Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<div class="container mt-4">
  <div id="alerts">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>
  {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
console.log('Script loaded and running');
// Clear Add Dog form when modal is opened
function attachAddDogModalReset() {
    var addDogModalEl = document.getElementById('addDogModal');
    if (addDogModalEl) {
        addDogModalEl.addEventListener('show.bs.modal', function () {
            document.getElementById('addDogForm').reset();
        });
    }
}
attachAddDogModalReset();

document.addEventListener('htmx:afterSwap', function(evt) {
    console.log('htmx:afterSwap fired', evt);
    // Re-attach the reset event after HTMX swaps the dog cards
    attachAddDogModalReset();
    // Auto-close and reset Add Dog modal after successful add
    if (evt.detail && evt.detail.target && evt.detail.target.id === 'dogCards') {
        var addDogModal = document.getElementById('addDogModal');
        var addDogForm = document.getElementById('addDogForm');
        if (addDogModal && addDogForm) {
            addDogForm.reset();
            var modal = bootstrap.Modal.getOrCreateInstance(addDogModal);
            console.log('Closing Add Dog modal (afterSwap)');
            modal.hide();
        }
    }
});

function attachEditDogFormDebug() {
    var editDogForm = document.getElementById('editDogForm');
    if (editDogForm && !editDogForm._debugAttached) {
        editDogForm.addEventListener('submit', function(e) {
            console.log('DEBUG: editDogForm action:', editDogForm.action);
            console.log('DEBUG: editDogForm hx-post:', editDogForm.getAttribute('hx-post'));
        });
        editDogForm._debugAttached = true;
    }
}

function fillEditDogModal(btn) {
    try {
        var form = document.getElementById('editDogForm');
        var nameField = form.querySelector('input[name="name"]');
        var statusField = form.querySelector('input[name="adoption_status"]');
        var ageField = form.querySelector('input[name="age"]');
        var breedField = form.querySelector('input[name="breed"]');
        var intakeDateField = form.querySelector('input[name="intake_date"]');
        var microchipIdField = form.querySelector('input[name="microchip_id"]');
        var notesField = form.querySelector('textarea[name="notes"]');
        var medicalInfoField = form.querySelector('textarea[name="medical_info"]');
        var idField = document.getElementById('editDogIdInput');
        var fromDetailsField = document.getElementById('editDogFromDetails');
        if (!form || !nameField || !statusField || !ageField || !breedField || !intakeDateField || !microchipIdField || !notesField || !medicalInfoField || !idField || !fromDetailsField) {
            console.error('Edit modal fields not found!');
            return;
        }
        nameField.value = btn.getAttribute('data-dog-name') || '';
        statusField.value = btn.getAttribute('data-dog-status') || '';
        ageField.value = btn.getAttribute('data-dog-age') || '';
        breedField.value = btn.getAttribute('data-dog-breed') || '';
        intakeDateField.value = btn.getAttribute('data-dog-intake-date') || '';
        microchipIdField.value = btn.getAttribute('data-dog-microchip-id') || '';
        notesField.value = btn.getAttribute('data-dog-notes') || '';
        medicalInfoField.value = btn.getAttribute('data-dog-medical-info') || '';
        idField.value = btn.getAttribute('data-dog-id') || '';
        // Set hx-target depending on page
        if (document.getElementById('dogCards')) {
            form.setAttribute('hx-target', '#dogCards');
            fromDetailsField.value = '';
        } else {
            form.setAttribute('hx-target', 'body');
            fromDetailsField.value = 'details';
        }
        attachEditDogFormDebug();
    } catch (e) {
        console.error('Error in fillEditDogModal:', e);
    }
}

function confirmDeleteDog(btn) {
    if (confirm('Are you sure you want to delete this dog?')) {
        htmx.ajax('POST', `/dog/${btn.getAttribute('data-dog-id')}/delete`, {target: '#dogCards', swap: 'outerHTML'});
    }
    return false;
}

// Close the Add Dog and Edit Dog modals after successful HTMX request
if (window.htmx) {
    htmx.on('htmx:afterRequest', function(evt) {
        console.log('htmx:afterRequest fired', evt);
        if (evt.target && evt.target.id === 'addDogForm') {
            var addDogModal = document.getElementById('addDogModal');
            var addDogForm = document.getElementById('addDogForm');
            if (addDogModal && addDogForm) {
                addDogForm.reset();
                var modal = bootstrap.Modal.getOrCreateInstance(addDogModal);
                console.log('Closing Add Dog modal (afterRequest)');
                modal.hide();
            }
        }
        if (evt.target && evt.target.id === 'editDogForm') {
            var editDogModal = document.getElementById('editDogModal');
            if (editDogModal) {
                var modal = bootstrap.Modal.getInstance(editDogModal);
                if (modal) {
                    modal.hide();
                }
            }
        }
    });
}

document.body.addEventListener('showAlert', function(event) {
  var data = event.detail;
  var alertsDiv = document.getElementById('alerts');
  if (alertsDiv && data && data.message) {
    var alert = document.createElement('div');
    alert.className = 'alert alert-' + (data.category || 'success') + ' alert-dismissible fade show';
    alert.role = 'alert';
    alert.innerHTML = data.message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    alertsDiv.innerHTML = '';
    alertsDiv.appendChild(alert);
  }
});
</script>
<!-- Edit Dog Modal (available on all pages) -->
<div class="modal fade" id="editDogModal" tabindex="-1" aria-labelledby="editDogModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editDogForm" method="post" hx-post="/dog/edit" hx-target="#dogCards" hx-swap="outerHTML">
        <div class="modal-header">
          <h5 class="modal-title" id="editDogModalLabel">Edit Dog</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="editDogModalBody">
          <div class='mb-3'>
            <label class='form-label'>Name*</label>
            <input type='text' class='form-control' name='name' required>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Adoption Status</label>
            <input type='text' class='form-control' name='adoption_status'>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Age</label>
            <input type='text' class='form-control' name='age'>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Breed</label>
            <input type='text' class='form-control' name='breed'>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Intake Date</label>
            <input type='date' class='form-control' name='intake_date'>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Microchip/ID</label>
            <input type='text' class='form-control' name='microchip_id'>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Notes</label>
            <textarea class='form-control' name='notes'></textarea>
          </div>
          <div class='mb-3'>
            <label class='form-label'>Medical Info</label>
            <textarea class='form-control' name='medical_info'></textarea>
          </div>
          <input type='hidden' name='dog_id' id='editDogIdInput'>
          <input type='hidden' name='from_details' id='editDogFromDetails'>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
</body>
</html> 