{% extends 'base.html' %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timeline.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-refined.css') }}">
{% endblock %}

{% block content %}
<style nonce="{{ g.csp_nonce }}">
.table th, .table td {
  vertical-align: middle;
  padding: 0.75rem;
}
.table th {
  font-weight: 600;
  font-size: 1.05rem;
}
</style>
<div class="container mt-4">
  <div class="mb-3">
    <a href="{{ url_for('dogs.dog_list_page') }}" class="btn btn-secondary breathe-hover">&larr; Back to Dogs in Care</a>
  </div>
  <!-- Enhanced Dog Profile Header -->
  <div class="card mb-4 dog-care-card">
    <div class="card-body">
      <!-- Dog Header Section -->
      <div class="dog-profile-header mb-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div class="dog-name-section">
            <h2 class="mb-2 text-caring-secondary">Caring for {{ dog.name }}</h2>
            
            <!-- Status Badge with Icon -->
            <div class="mb-3">
              {% set status = dog.adoption_status or 'Unknown' %}
              {% set status_value=status %}
              {% set status_type="adoption" %}
              {% set size="lg" %}
              {% set additional_classes="status-badge fs-6 px-3 py-2" %}
              {% include 'partials/status_badge.html' %}
            </div>
            
            <!-- Energy Level Badge -->
            {% if dog.energy_level %}
              <div class="mb-2">
                {% set status_value=dog.energy_level %}
                {% set status_type="energy" %}
                {% set size="lg" %}
                {% set additional_classes="energy-level-badge fs-6 px-3 py-2" %}
                {% include 'partials/status_badge.html' %}
              </div>
            {% endif %}
          </div>
          
          <!-- Action Buttons -->
          <div class="dog-actions d-flex flex-column gap-2">
            <a href="{{ url_for('dogs.dog_history', dog_id=dog.id) }}" 
               class="btn btn-outline-caring-primary btn-lg breathe-hover d-flex align-items-center">
              <i class="bi bi-map me-2"></i>{{ dog.name }}'s Journey
            </a>
            <button class="btn btn-caring-primary btn-lg breathe-hover d-flex align-items-center" 
                    data-bs-toggle="modal" data-bs-target="#editDogModal"
                    data-dog-id="{{ dog.id }}"
                    data-dog-name="{{ dog.name }}"
                    data-dog-status="{{ dog.adoption_status or '' }}"
                    data-dog-age="{{ dog.age or '' }}"
                    data-dog-breed="{{ dog.breed or '' }}"
                    data-dog-intake-date="{{ dog.intake_date or '' }}"
                    data-dog-microchip-id="{{ dog.microchip_id or '' }}"
                    data-dog-notes="{{ dog.notes or '' }}"
                    data-dog-medical-info="{{ dog.medical_info or '' }}">
              <i class="bi bi-pencil me-2"></i>Edit Details
            </button>
          </div>
        </div>
      </div>
      
      <!-- Key Information Grid -->
      <div class="dog-info-grid">
        <div class="row g-3">
          <div class="col-md-6 col-lg-3">
            <div class="info-card caring-info-card">
              <div class="info-icon">
                <i class="bi bi-calendar3 text-caring-accent"></i>
              </div>
              <div class="info-content">
                <div class="info-label">Age</div>
                <div class="info-value">{{ dog.age or 'Unknown' }}</div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3">
            <div class="info-card caring-info-card">
              <div class="info-icon">
                <i class="bi bi-award text-caring-accent"></i>
              </div>
              <div class="info-content">
                <div class="info-label">Breed</div>
                <div class="info-value">{{ dog.breed or 'Mixed' }}</div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3">
            <div class="info-card caring-info-card">
              <div class="info-icon">
                <i class="bi bi-house-door text-caring-accent"></i>
              </div>
              <div class="info-content">
                <div class="info-label">Intake Date</div>
                <div class="info-value">
                  {% if dog.intake_date %}
                    {{ dog.intake_date.strftime('%m/%d/%Y') }}
                  {% else %}
                    Not recorded
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3">
            <div class="info-card caring-info-card">
              <div class="info-icon">
                <i class="bi bi-credit-card text-caring-accent"></i>
              </div>
              <div class="info-content">
                <div class="info-label">Microchip ID</div>
                <div class="info-value">{{ dog.microchip_id or 'Not chipped' }}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Days in Care Calculation -->
        {% if dog.intake_date %}
          <div class="mt-3">
            <div class="info-card caring-info-card special-highlight">
              <div class="info-icon">
                <i class="bi bi-heart-pulse text-caring-primary"></i>
              </div>
              <div class="info-content">
                <div class="info-label">Days in Care</div>
                <div class="info-value fs-5 fw-bold text-caring-primary">
                  {{ (now.date() - dog.intake_date).days }} days
                </div>
              </div>
            </div>
          </div>
        {% endif %}
        
        <!-- Notes and Medical Info -->
        {% if dog.notes or dog.medical_info %}
          <div class="mt-4">
            <div class="row g-3">
              {% if dog.notes %}
                <div class="col-md-6">
                  <div class="notes-card caring-notes-card">
                    <div class="notes-header">
                      <i class="bi bi-journal-text text-caring-accent me-2"></i>
                      <span class="fw-bold">Care Notes</span>
                    </div>
                    <div class="notes-content">
                      {{ dog.notes }}
                    </div>
                  </div>
                </div>
              {% endif %}
              
              {% if dog.medical_info %}
                <div class="col-md-6">
                  <div class="notes-card caring-notes-card medical-notes">
                    <div class="notes-header">
                      <i class="bi bi-shield-plus text-caring-warning me-2"></i>
                      <span class="fw-bold">Medical Information</span>
                    </div>
                    <div class="notes-content">
                      {{ dog.medical_info }}
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Enhanced Personality Section -->
  <div class="card mt-4 dog-care-card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0 d-flex align-items-center">
        <i class="bi bi-heart-pulse me-2 text-caring-primary"></i>
        {{ dog.name }}'s Personality
      </h4>
      <div class="d-flex align-items-center gap-2">
        {% if dog.personality_notes or dog.energy_level or dog.social_notes or dog.special_story or dog.temperament_tags %}
          <button class="btn btn-outline-caring-primary btn-sm breathe-hover" 
                  data-bs-toggle="collapse" 
                  data-bs-target="#personalitySection" 
                  aria-expanded="true" 
                  aria-controls="personalitySection">
            <i class="bi bi-chevron-up"></i> Hide Details
          </button>
        {% endif %}
        <button class="btn btn-caring-primary btn-sm breathe-hover" 
                data-bs-toggle="modal" 
                data-bs-target="#editPersonalityModal"
                data-dog-id="{{ dog.id }}"
                data-dog-name="{{ dog.name }}"
                data-dog-energy-level="{{ dog.energy_level or '' }}"
                data-dog-temperament-tags="{{ dog.temperament_tags or '' }}"
                data-dog-personality-notes="{{ dog.personality_notes or '' }}"
                data-dog-social-notes="{{ dog.social_notes or '' }}"
                data-dog-special-story="{{ dog.special_story or '' }}">
          <i class="bi bi-heart-pulse me-1"></i>Edit Personality
        </button>
      </div>
    </div>
    
    <!-- Personality Quick Summary (Always Visible) -->
    <div class="card-body pb-2">
      <div class="personality-summary">
        <div class="row g-3">
          <!-- Energy Level -->
          <div class="col-auto">
            <div class="personality-quick-card">
              <div class="quick-card-icon">
                <i class="bi bi-lightning text-caring-accent"></i>
              </div>
              <div class="quick-card-content">
                <div class="quick-card-label">Energy</div>
                <div class="quick-card-value">
                  {% if dog.energy_level %}
                    {% set status_value=dog.energy_level %}
                    {% set status_type="energy" %}
                    {% set additional_classes="energy-level-badge" %}
                    {% include 'partials/status_badge.html' %}
                  {% else %}
                    <span class="text-muted small">Unknown</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Temperament Count -->
          <div class="col-auto">
            <div class="personality-quick-card">
              <div class="quick-card-icon">
                <i class="bi bi-tags text-caring-accent"></i>
              </div>
              <div class="quick-card-content">
                <div class="quick-card-label">Traits</div>
                <div class="quick-card-value">
                  {% if dog.temperament_tags %}
                    <span class="badge temperament-count-badge">
                      {{ dog.temperament_tags.split(',')|length }} traits
                    </span>
                  {% else %}
                    <span class="text-muted small">None yet</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Social Status -->
          <div class="col-auto">
            <div class="personality-quick-card">
              <div class="quick-card-icon">
                <i class="bi bi-people text-caring-accent"></i>
              </div>
              <div class="quick-card-content">
                <div class="quick-card-label">Social</div>
                <div class="quick-card-value">
                  {% if dog.social_notes %}
                    <i class="bi bi-check-circle text-success"></i>
                    <span class="text-success small">Noted</span>
                  {% else %}
                    <span class="text-muted small">TBD</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Detailed Personality Section -->
    <div class="collapse{% if dog.personality_notes or dog.energy_level or dog.social_notes or dog.special_story or dog.temperament_tags %} show{% endif %}" id="personalitySection">
      <div class="card-body pt-2">
        {% if dog.personality_notes or dog.energy_level or dog.social_notes or dog.special_story or dog.temperament_tags %}
          <div class="personality-details">
            <!-- Temperament Tags -->
            {% if dog.temperament_tags %}
              <div class="mb-4">
                <h6 class="personality-section-title">
                  <i class="bi bi-tags me-2 text-caring-accent"></i>
                  Temperament Traits
                </h6>
                <div class="temperament-tags-display">
                  {% for tag in dog.temperament_tags.split(',') %}
                    {% if tag.strip() %}
                      <span class="badge temperament-tag me-2 mb-2">
                        {{ tag.strip() }}
                      </span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            
            <!-- Personality Notes and Social Notes -->
            <div class="row g-4">
              {% if dog.personality_notes %}
                <div class="col-md-6">
                  <div class="personality-detail-card">
                    <h6 class="personality-section-title">
                      <i class="bi bi-journal-heart me-2 text-caring-primary"></i>
                      Personality Notes
                    </h6>
                    <div class="personality-content">
                      {{ dog.personality_notes }}
                    </div>
                  </div>
                </div>
              {% endif %}
              
              {% if dog.social_notes %}
                <div class="col-md-6">
                  <div class="personality-detail-card">
                    <h6 class="personality-section-title">
                      <i class="bi bi-people-fill me-2 text-caring-accent"></i>
                      Social Preferences
                    </h6>
                    <div class="personality-content">
                      {{ dog.social_notes }}
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
            
            <!-- Special Story -->
            {% if dog.special_story %}
              <div class="mt-4">
                <div class="personality-detail-card special-story-card">
                  <h6 class="personality-section-title">
                    <i class="bi bi-book-heart me-2 text-caring-warning"></i>
                    Special Story
                  </h6>
                  <div class="personality-content">
                    {{ dog.special_story }}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% else %}
          <!-- Empty State -->
          {% set icon="bi bi-heart" %}
          {% set title=dog.name ~ "'s unique personality awaits discovery" %}
          {% set message="Every dog has their own special character - help us learn about " ~ dog.name %}
          {% set action_text="Add Personality Details" %}
          {% set action_modal="#editPersonalityModal" %}
          {% set action_class="btn-caring-primary" %}
          {% include 'partials/empty_state.html' %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Phase 5B: Recent Activity Widget -->
  <div class="row">
    <!-- Enhanced Recent Activity Timeline -->
    <div class="col-lg-8">
      {% if recent_history_events %}
        <div class="card mt-4 dog-care-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0 d-flex align-items-center">
              <i class="bi bi-clock-history text-caring-primary me-2"></i>
              Recent Activity
            </h4>
            <div>
              <span class="badge activity-count-badge">{{ recent_history_events|length }} recent events</span>
            </div>
          </div>
          <div class="card-body">
            <div class="enhanced-timeline">
              <!-- Always Show First 2 Events -->
              {% for event in recent_history_events[:2] %}
                <div class="timeline-event {% if not loop.last and loop.index < 2 %}has-next{% endif %}{% if loop.index == 2 and recent_history_events|length > 2 %} has-next{% endif %}">
                  <div class="event-indicator">
                    <div class="event-icon 
                            {% if event.source_model == 'DogNote' %}event-note
                            {% elif event.source_model == 'Appointment' %}event-appointment
                            {% elif event.source_model == 'DogMedicine' %}event-medicine
                            {% elif event.source_model == 'Reminder' %}event-reminder
                            {% else %}event-default
                            {% endif %}">
                      {% if event.source_model == 'DogNote' %}
                        <i class="bi bi-chat-square-text"></i>
                      {% elif event.source_model == 'Appointment' %}
                        <i class="bi bi-calendar-event"></i>
                      {% elif event.source_model == 'DogMedicine' %}
                        <i class="bi bi-capsule"></i>
                      {% elif event.source_model == 'Reminder' %}
                        <i class="bi bi-bell"></i>
                      {% else %}
                        <i class="bi bi-circle"></i>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="event-content">
                    <div class="event-header">
                      <div class="event-title">{{ event.event_type }}</div>
                      <div class="event-time">{{ event.timestamp.strftime('%m/%d %I:%M %p') }}</div>
                    </div>
                    
                    <div class="event-description">
                      {{ event.description|truncate(150) }}
                    </div>
                    
                    {% if event.author %}
                      <div class="event-author">
                        <i class="bi bi-person text-caring-accent me-1"></i>
                        {{ event.author }}
                      </div>
                    {% endif %}
                    
                    <!-- Event Type Badge -->
                    <div class="event-meta">
                      <span class="badge event-type-badge 
                              {% if event.source_model == 'DogNote' %}badge-note
                              {% elif event.source_model == 'Appointment' %}badge-appointment
                              {% elif event.source_model == 'DogMedicine' %}badge-medicine
                              {% elif event.source_model == 'Reminder' %}badge-reminder
                              {% else %}badge-default
                              {% endif %}">
                        {% if event.source_model == 'DogNote' %}
                          <i class="bi bi-chat-square-text me-1"></i>Note
                        {% elif event.source_model == 'Appointment' %}
                          <i class="bi bi-calendar-event me-1"></i>Appointment
                        {% elif event.source_model == 'DogMedicine' %}
                          <i class="bi bi-capsule me-1"></i>Medicine
                        {% elif event.source_model == 'Reminder' %}
                          <i class="bi bi-bell me-1"></i>Reminder
                        {% else %}
                          <i class="bi bi-circle me-1"></i>Activity
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              {% endfor %}
              
              <!-- Collapsible Additional Events -->
              {% if recent_history_events|length > 2 %}
                <div class="collapse" id="additionalEvents">
                  {% for event in recent_history_events[2:] %}
                    <div class="timeline-event {% if not loop.last %}has-next{% endif %}">
                      <div class="event-indicator">
                        <div class="event-icon 
                                {% if event.source_model == 'DogNote' %}event-note
                                {% elif event.source_model == 'Appointment' %}event-appointment
                                {% elif event.source_model == 'DogMedicine' %}event-medicine
                                {% elif event.source_model == 'Reminder' %}event-reminder
                                {% else %}event-default
                                {% endif %}">
                          {% if event.source_model == 'DogNote' %}
                            <i class="bi bi-chat-square-text"></i>
                          {% elif event.source_model == 'Appointment' %}
                            <i class="bi bi-calendar-event"></i>
                          {% elif event.source_model == 'DogMedicine' %}
                            <i class="bi bi-capsule"></i>
                          {% elif event.source_model == 'Reminder' %}
                            <i class="bi bi-bell"></i>
                          {% else %}
                            <i class="bi bi-circle"></i>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="event-content">
                        <div class="event-header">
                          <div class="event-title">{{ event.event_type }}</div>
                          <div class="event-time">{{ event.timestamp.strftime('%m/%d %I:%M %p') }}</div>
                        </div>
                        
                        <div class="event-description">
                          {{ event.description|truncate(150) }}
                        </div>
                        
                        {% if event.author %}
                          <div class="event-author">
                            <i class="bi bi-person text-caring-accent me-1"></i>
                            {{ event.author }}
                          </div>
                        {% endif %}
                        
                        <!-- Event Type Badge -->
                        <div class="event-meta">
                          <span class="badge event-type-badge 
                                  {% if event.source_model == 'DogNote' %}badge-note
                                  {% elif event.source_model == 'Appointment' %}badge-appointment
                                  {% elif event.source_model == 'DogMedicine' %}badge-medicine
                                  {% elif event.source_model == 'Reminder' %}badge-reminder
                                  {% else %}badge-default
                                  {% endif %}">
                            {% if event.source_model == 'DogNote' %}
                              <i class="bi bi-chat-square-text me-1"></i>Note
                            {% elif event.source_model == 'Appointment' %}
                              <i class="bi bi-calendar-event me-1"></i>Appointment
                            {% elif event.source_model == 'DogMedicine' %}
                              <i class="bi bi-capsule me-1"></i>Medicine
                            {% elif event.source_model == 'Reminder' %}
                              <i class="bi bi-bell me-1"></i>Reminder
                            {% else %}
                              <i class="bi bi-circle me-1"></i>Activity
                            {% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            
            <!-- Activity Action Buttons -->
            <div class="activity-actions mt-4">
              {% if recent_history_events|length > 2 %}
                <div class="text-center mb-3">
                  <button class="btn btn-outline-caring-secondary btn-sm breathe-hover" 
                          data-bs-toggle="collapse" 
                          data-bs-target="#additionalEvents" 
                          aria-expanded="false" 
                          aria-controls="additionalEvents"
                          id="toggleMoreEvents">
                    <span class="show-more-text">
                      <i class="bi bi-chevron-down me-1"></i>Show {{ recent_history_events|length - 2 }} More Events
                    </span>
                    <span class="show-less-text d-none">
                      <i class="bi bi-chevron-up me-1"></i>Show Less
                    </span>
                  </button>
                </div>
              {% endif %}
              
              <div class="text-center">
                <a href="{{ url_for('dogs.dog_history', dog_id=dog.id) }}" 
                   class="btn btn-outline-caring-primary breathe-hover">
                  <i class="bi bi-clock-history me-2"></i>View Complete History
                </a>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <!-- No Activity State -->
        <div class="card mt-4 dog-care-card">
          <div class="card-header">
            <h4 class="mb-0 d-flex align-items-center">
              <i class="bi bi-clock-history text-caring-primary me-2"></i>
              Recent Activity
            </h4>
          </div>
          <div class="card-body text-center py-5">
            <i class="bi bi-clock text-caring-secondary mb-3 large-icon"></i>
            <h5 class="text-caring-secondary">{{ dog.name }}'s care journey is just beginning</h5>
            <p class="text-muted mb-3">Activity will appear here as {{ dog.name }} receives care and attention</p>
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-caring-primary btn-sm breathe-hover" 
                      data-bs-toggle="modal" data-bs-target="#addAppointmentModal" data-dog-id="{{ dog.id }}">
                <i class="bi bi-calendar-plus me-1"></i>Schedule Appointment
              </button>
              <button class="btn btn-outline-caring-primary btn-sm breathe-hover" 
                      data-bs-toggle="modal" data-bs-target="#addMedicineModal" data-dog-id="{{ dog.id }}">
                <i class="bi bi-capsule me-1"></i>Add Medicine
              </button>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
    
    <!-- Enhanced Quick Stats Sidebar -->
    <div class="col-lg-4">
      <div class="card mt-4 dog-care-card">
        <div class="card-header">
          <h5 class="mb-0 d-flex align-items-center">
            <i class="bi bi-graph-up text-caring-primary me-2"></i>
            Care Statistics
          </h5>
        </div>
        <div class="card-body">
          <div class="stats-grid">
            <!-- Appointments Stat -->
            <div class="stat-item">
              <div class="stat-icon">
                <i class="bi bi-calendar-check text-caring-primary"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number">{{ dog.appointments|length }}</div>
                <div class="stat-label">Total Appointments</div>
                {% if dog.appointments|length > 0 %}
                  <div class="stat-extra">
                    {% set upcoming = dog.appointments|selectattr('status', 'equalto', 'scheduled')|list|length %}
                    {% if upcoming > 0 %}
                      <span class="badge stat-badge-upcoming">{{ upcoming }} upcoming</span>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Medications Stat -->
            <div class="stat-item">
              <div class="stat-icon">
                <i class="bi bi-capsule text-caring-accent"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number">{{ dog.medicines|length }}</div>
                <div class="stat-label">Active Medications</div>
                {% if dog.medicines|length > 0 %}
                  <div class="stat-extra">
                    {% set active = dog.medicines|selectattr('status', 'equalto', 'active')|list|length %}
                    <span class="badge stat-badge-active">{{ active }} active</span>
                  </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Days in Care -->
            {% if dog.intake_date %}
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bi bi-heart-pulse text-caring-warning"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number">{{ (now.date() - dog.intake_date).days }}</div>
                  <div class="stat-label">Days in Care</div>
                  <div class="stat-extra">
                    <span class="text-muted small">Since {{ dog.intake_date.strftime('%m/%d/%y') }}</span>
                  </div>
                </div>
              </div>
            {% endif %}
            
            <!-- Last Activity -->
            <div class="stat-item">
              <div class="stat-icon">
                <i class="bi bi-clock-history text-caring-secondary"></i>
              </div>
              <div class="stat-content">
                {% if recent_history_events %}
                  {% set last_event = recent_history_events[0] %}
                  <div class="stat-number">{{ last_event.timestamp.strftime('%m/%d') }}</div>
                  <div class="stat-label">Last Update</div>
                  <div class="stat-extra">
                    <span class="text-muted small">{{ last_event.event_type }}</span>
                  </div>
                {% else %}
                  <div class="stat-number text-muted">â€”</div>
                  <div class="stat-label">Last Update</div>
                  <div class="stat-extra">
                    <span class="text-muted small">No activity yet</span>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Care Progress Indicator -->
          {% if dog.intake_date %}
            <div class="care-progress mt-4">
              <div class="progress-header">
                <div class="progress-label">
                  <i class="bi bi-heart text-caring-primary me-2"></i>
                  Care Journey Progress
                </div>
              </div>
              <div class="progress-indicators mt-2">
                <div class="progress-step {% if dog.intake_date %}completed{% endif %}">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>Intake</span>
                </div>
                <div class="progress-step {% if dog.medicines|length > 0 or dog.appointments|length > 0 %}completed{% endif %}">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>Care Started</span>
                </div>
                <div class="progress-step {% if dog.adoption_status == 'Adopted' %}completed{% endif %}">
                  <i class="bi bi-{% if dog.adoption_status == 'Adopted' %}check-circle-fill{% else %}circle{% endif %}"></i>
                  <span>{% if dog.adoption_status == 'Adopted' %}Adopted{% else %}Finding Home{% endif %}</span>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Appointments Section -->
  <div class="card mt-4 dog-care-card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0 d-flex align-items-center">
        <i class="bi bi-calendar-check text-caring-primary me-2"></i>
        Appointments
      </h4>
      <button class="btn btn-caring-primary breathe-hover" data-bs-toggle="modal" data-bs-target="#addAppointmentModal" data-dog-id="{{ dog.id }}">
        <i class="bi bi-plus-circle me-2"></i>Schedule Appointment
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        {% include 'partials/appointments_list.html' %}
      </div>
    </div>
  </div>

  <!-- Enhanced Medicines Section -->
  <div class="card mt-4 dog-care-card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0 d-flex align-items-center">
        <i class="bi bi-capsule text-caring-accent me-2"></i>
        Medications
      </h4>
      <button class="btn btn-caring-accent breathe-hover" data-bs-toggle="modal" data-bs-target="#addMedicineModal" data-dog-id="{{ dog.id }}">
        <i class="bi bi-plus-circle me-2"></i>Add Medicine
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive" id="medicines-list">
        {% include 'partials/medicines_list.html' %}
      </div>
    </div>
  </div>
</div>

<!-- Move modal include to the end of the file -->
{% include 'partials/add_edit_modal.html' %}
{% endblock %}

{% block scripts %}
<script type="text/javascript" nonce="{{ g.csp_nonce }}">
/* eslint-disable */
window.appointmentTypes = {{ appointment_types|tojson|safe }};
window.appointmentUrls = {
    add: '{{ url_for("appointments.add_appointment", dog_id=dog.id) }}',
    editTemplate: '/dog/{{ dog.id }}/appointment/edit/',
    apiGetTemplate: '/api/appointment/'
};
window.medicineUrls = {
    add: '{{ url_for("medicines.add_medicine", dog_id=dog.id) }}',
    editTemplate: '{{ url_for("medicines.edit_medicine", dog_id=dog.id, medicine_id=1) }}'.replace('/1', '/'),
    deleteTemplate: '{{ url_for("medicines.delete_medicine", dog_id=dog.id, medicine_id=1) }}'.replace('/1', '/'),
    apiGetTemplate: '{{ url_for("medicines.api_get_medicine", medicine_id=1) }}'.replace('/1', '/')
};
{# The following line was causing an error because 'medicine_presets' is no longer passed. #}
{# It has been replaced by 'medicine_presets_categorized'. #}
{# window.medicinePresets = {{ medicine_presets|tojson|safe }}; #}

function cleanupModalArtifacts() {
  const openModalEl = document.querySelector('.modal.show');
  if (openModalEl) {
    const modalInstance = bootstrap.Modal.getInstance(openModalEl);
    if (modalInstance) {
      modalInstance.hide();
    } else {
      openModalEl.classList.remove('show');
    }
  }
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

document.addEventListener('hidden.bs.modal', cleanupModalArtifacts);

document.body.addEventListener('htmx:afterSettle', function(event) {
    // Only run cleanup if the target of the swap wasn't an error display
    // area within one of our known modals. This prevents closing the modal
    // when an error message is intentionally displayed inside it.
    const errorTargets = ['#addAppointmentModalError', '#addMedicineModalError', '#editAppointmentModalError', '#editMedicineModalError']; 
    // Add other error display IDs if you have more modals with this pattern
    
    let isErrorTargetSwap = false;
    if (event.detail.target) {
        const targetId = event.detail.target.id;
        if (targetId && errorTargets.some(errorId => errorId === '#' + targetId)) {
            isErrorTargetSwap = true;
        }
    }

    if (!isErrorTargetSwap) {
        cleanupModalArtifacts();
    }
});

document.body.addEventListener('click', function(event) {
  if (event.target.matches('.js-edit-trigger')) {
    event.preventDefault();
    const targetSelector = event.target.getAttribute('data-bs-target');
    if (targetSelector) {
      const modalElement = document.querySelector(targetSelector);
      if (modalElement) {
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
        modalInstance.show();
      }
    }
  }
});

// ----- NEW JAVASCRIPT FOR MEDICINE FORM DYNAMICS -----

function updateMedicineFormElements(presetSelectElement, unitContainerId, dosageInstructionsDisplayId, unitInputName, unitInputId) {
    const selectedOption = presetSelectElement.options[presetSelectElement.selectedIndex];
    const dosageInstructionsDisplay = document.getElementById(dosageInstructionsDisplayId);

    if (!selectedOption || !selectedOption.value) {
        if(dosageInstructionsDisplay) dosageInstructionsDisplay.innerHTML = '&nbsp;';
        return;
    }

    const dosageInstructions = selectedOption.dataset.dosageInstructions;

    if(dosageInstructionsDisplay) {
        dosageInstructionsDisplay.textContent = dosageInstructions || '';
        if (!dosageInstructionsDisplay.textContent) dosageInstructionsDisplay.innerHTML = '&nbsp;';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const addMedPresetSelect = document.getElementById('addMedPreset');
    if (addMedPresetSelect) {
        addMedPresetSelect.addEventListener('change', function() {
            updateMedicineFormElements(this, '', 'addMedDosageInstructionsDisplay', '', '');
        });
        if(addMedPresetSelect.value) {
             updateMedicineFormElements(addMedPresetSelect, '', 'addMedDosageInstructionsDisplay', '', '');
        }
    }

    const editMedPresetSelect = document.getElementById('editMedPreset');
    if (editMedPresetSelect) {
        editMedPresetSelect.addEventListener('change', function() {
            updateMedicineFormElements(this, '', 'editMedDosageInstructionsDisplay', '', '');
        });
    }

    // Reset Add Medicine Modal form when it's about to be shown
    const addMedicineModalElement = document.getElementById('addMedicineModal');
    if (addMedicineModalElement) {
        addMedicineModalElement.addEventListener('show.bs.modal', function () {
            const form = this.querySelector('form');
            if (form) {
                form.reset(); // Reset all form fields to their defaults
            }
            
            const errorDisplay = this.querySelector('#addMedicineModalError');
            if (errorDisplay) {
                errorDisplay.innerHTML = '';
            }

            const medPresetSelect = this.querySelector('#addMedPreset');
            if (medPresetSelect) {
                medPresetSelect.value = ''; 
                updateMedicineFormElements(medPresetSelect, '', 'addMedDosageInstructionsDisplay', '', '');
            }
        });
    }

    // Populate Edit Medicine Modal when it's about to be shown
    const editMedicineModalElement = document.getElementById('editMedicineModal');
    if (editMedicineModalElement) {
        editMedicineModalElement.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget; 
            if (!button) return;

            // Reset form and clear errors first
            const form = this.querySelector('form');
            if (form) {
                form.reset();
            }
            const errorDisplayModal = this.querySelector('#editMedicineModalError');
            if (errorDisplayModal) {
                errorDisplayModal.innerHTML = '';
            }
            // Reset dynamic fields (dosage instructions, unit input) to default state
            const medPresetSelect = this.querySelector('#editMedPreset');
            if (medPresetSelect) {
                medPresetSelect.value = ''; // Ensure it's reset before populating
                updateMedicineFormElements(medPresetSelect, '', 'editMedDosageInstructionsDisplay', '', '');
            }

            const medicineId = button.dataset.medicineId;
            const dogId = button.dataset.dogId; 
            
            if (!form || !medicineId || !dogId) {
                if(errorDisplayModal) errorDisplayModal.textContent = 'Error: Could not initialize form.';
                return;
            }

            const actionUrl = window.medicineUrls.editTemplate + medicineId;
            form.setAttribute('action', actionUrl);
            form.setAttribute('hx-post', actionUrl);
            
            // Force HTMX to process the form again after we've set the attributes
            if (typeof htmx !== 'undefined') {
                htmx.process(form);
            }
            
            try {
                const response = await fetch(window.medicineUrls.apiGetTemplate + medicineId);
                if (!response.ok) {
                    const errorDisplay = this.querySelector('#editMedicineModalError'); 
                    if(errorDisplay) errorDisplay.textContent = 'Could not load medicine details.';
                    return;
                }
                const medDetails = await response.json();

                form.querySelector('#editMedId').value = medDetails.id;
                
                if (medPresetSelect) {
                    medPresetSelect.value = medDetails.medicine_id; // Set the value AFTER options are confirmed to be there
                } else {
                    console.error('#editMedPreset dropdown NOT FOUND');
                }
                
                form.querySelector('#editMedDosage').value = medDetails.dosage || '';
                
                // Map frequency values to dropdown options
                let frequencyValue = medDetails.frequency || '';
                if (frequencyValue.trim() === '') {
                    frequencyValue = 'SID';
                } else if (frequencyValue.toLowerCase() === 'daily') {
                    frequencyValue = 'SID';
                } else if (frequencyValue.toLowerCase() === 'twice daily') {
                    frequencyValue = 'BID';
                }
                
                form.querySelector('#editMedFrequency').value = frequencyValue;
                form.querySelector('#editMedStart').value = medDetails.start_date || '';
                form.querySelector('#editMedEnd').value = medDetails.end_date || '';
                form.querySelector('#editMedStatus').value = medDetails.status || 'active';
                form.querySelector('#editMedNotes').value = medDetails.notes || '';
                
                // Set the form field if it exists
                const formField = form.querySelector('#editMedForm');
                if (formField) {
                    formField.value = medDetails.form || '';
                }

                updateMedicineFormElements(medPresetSelect, '', 'editMedDosageInstructionsDisplay', '', '');
                
                // Now set the unit value directly on the select element
                const unitField = form.querySelector('#editMedUnit');
                if (unitField) {
                    unitField.value = medDetails.unit || '';
                }

            } catch (error) {
                console.error('Error fetching or populating medicine details:', error);
                const errorDisplay = this.querySelector('#editMedicineModalError');
                if(errorDisplay) errorDisplay.textContent = 'Error loading medicine data.';
            }
        });
    }
});

// ----- END OF NEW JAVASCRIPT -----

// Toggle button text for show more/less events
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleMoreEvents');
    if (toggleButton) {
        const additionalEvents = document.getElementById('additionalEvents');
        const showMoreText = toggleButton.querySelector('.show-more-text');
        const showLessText = toggleButton.querySelector('.show-less-text');
        
        // Listen for Bootstrap collapse events
        if (additionalEvents) {
            additionalEvents.addEventListener('shown.bs.collapse', function() {
                showMoreText.classList.add('d-none');
                showLessText.classList.remove('d-none');
            });
            
            additionalEvents.addEventListener('hidden.bs.collapse', function() {
                showMoreText.classList.remove('d-none');
                showLessText.classList.add('d-none');
            });
        }
    }
});

</script>
{% endblock %} 